<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Task 2</title>
        <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    </head>
    <body>
        <h1>Live Plot</h1>
        <button id="connect">Connect to Arduino</button>
        <div id="plot" style="width:100%;height:400px;"></div>
        <div id="plot3d" style="width:100%;height:400px;"></div>

        <script>
            //setup
            let port, reader;
            let textDecoder = new TextDecoderStream();
            let inputDone, inputStream;

            let timeData = [], sensorData = [];
            let latData = [], lonData = [], altData = [];


            //serial
            document.getElementById("connect").addEventListener("click", async () => {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({baudRate: 9600});

                    inputDone = port.readable.pipeTo(textDecoder.writable);
                    inputStream = textDecoder.readable;
                    reader = inputStream.getReader();

                    Plotly.newPlot("plot", [{ y: [], type: "line" }], { title: "Sensor Data (2D)" });
                    Plotly.newPlot("plot3d", [{
                      x: [], y: [], z: [], mode: "lines+markers", type: "scatter3d"
                    }], { title: "3D Position (Lat, Lon, Alt)" });

                    readLoop();
                } catch (err) {
                  console.error("Connection Error:", err);
                }
            });


            //logic
            async function readLoop() {
                let startTime = Date.now();
                while(true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    if (value) {
                        let lines = value.split("\n");
                        for (let line of lines) {
                            line = line.trim();
                            if (!line) continue;

                            let parts = line.spilt(",");
                            if (parts.length === 1) {
                                let sensorVal = parseFloat(parts[0]);
                                let t = (Date.now() - startTime) / 1000;
                                timeData.push(t);
                                sensorData.push(sensorVal);
                                Plotly.update("plot", {x: [timeData], y: [sensorData]});
                            } else if (parts.length === 3){
                                let lat = parseFloat(parts[0]);
                                let lon = parseFloat(parts[1]);
                                let alt = parseFloat(parts[2]);
                                latData.push(lat); 
                                lonData.push(lon); 
                                altData.push(alt);
                                Plotly.update("plot3d", {x: [lonData], y: [latData], z: [altData]});
                            }
                        }
                    }
                }
            }
        </script>
    </body>
</html>
